<!DOCTYPE html>
<html lang="ru">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart Device Control</title>
    <link rel="stylesheet" href="../assets/css/smartdim.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>

<body>
    <div id="notificationContainer" class="notification-container"></div>

    <div class="container">
        <div class="header">
            <div class="group-name">üí°–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –æ—Å–≤–µ—â–µ–Ω–∏–µ–º</div>
            <input type="text" id="deviceNameInput" class="device-name-input" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞"
                value="Smart Dimmer #1">
            <div class="status">
                <div class="status-dot-online"></div>
                –û–Ω–ª–∞–π–Ω
            </div>
        </div>

        <div class="content">
            <div class="section">
                <div class="section-title">–¢–µ–∫—É—â–∏–µ –¥–∞–Ω–Ω—ã–µ</div>
                <div class="data-grid">
                    <div class="data-card">
                        <div class="data-value">--¬∞C</div>
                        <div class="data-label">–¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞</div>
                    </div>
                    <div class="data-card">
                        <div class="data-value">--%</div>
                        <div class="data-label">–í–ª–∞–∂–Ω–æ—Å—Ç—å</div>
                    </div>
                    <div class="data-card">
                        <div class="data-value">--kPa</div>
                        <div class="data-label">VPD</div>
                    </div>
                    <div class="data-card">
                        <div class="data-value">45%</div>
                        <div class="data-label">LED —è—Ä–∫–æ—Å—Ç—å</div>
                    </div>
                </div>
            </div>

            <div class="section">
                <div class="section-title">–ü–∞—Ä–∞–º–µ—Ç—Ä—ã –æ—Å–≤–µ—â–µ–Ω–∏—è</div>
                <div class="lighting-control-container">
                    <div class="form-group">
                        <div class="range-group">
                            <div class="range-header">
                                <label class="form-label" style="margin-bottom: 0;">–ù–∞—á–∞–ª—å–Ω–∞—è —è—Ä–∫–æ—Å—Ç—å</label>
                                <span class="range-value" id="minBrightnessValue">10%</span>
                            </div>
                            <input type="range" class="range-input" min="0" max="100" value="10" id="minBrightness">
                        </div>
                    </div>
                    <div class="form-group">
                        <div class="range-group">
                            <div class="range-header">
                                <label class="form-label" style="margin-bottom: 0;">–ú–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è —è—Ä–∫–æ—Å—Ç—å</label>
                                <span class="range-value" id="maxBrightnessValue">80%</span>
                            </div>
                            <input type="range" class="range-input" min="0" max="100" value="80" id="maxBrightness">
                        </div>
                    </div>
                </div>
            </div>

            <div class="section">
                <div class="section-title">–†–∞—Å–ø–∏—Å–∞–Ω–∏–µ</div>
                <div class="schedule-container">
                    <div class="time-row">
                        <div class="time-input-group">
                            <div class="time-label">–í–∫–ª—é—á–µ–Ω–∏–µ</div>
                            <input type="time" class="time-input" value="08:00">
                        </div>
                        <div class="time-separator">‚Üí</div>
                        <div class="time-input-group">
                            <div class="time-label">–í—ã–∫–ª—é—á–µ–Ω–∏–µ</div>
                            <input type="time" class="time-input" value="20:00">
                        </div>
                    </div>

                    <div class="setting-row">
                        <div class="setting-label">–†–∞—Å—Å–≤–µ—Ç/–∑–∞–∫–∞—Ç:</div>
                        <div class="setting-control">
                            <select class="modern-select">
                                <option value="30">30 –º–∏–Ω</option>
                                <option value="45">45 –º–∏–Ω</option>
                                <option value="60" selected>60 –º–∏–Ω</option>
                                <option value="90">90 –º–∏–Ω</option>
                                <option value="120">120 –º–∏–Ω</option>
                            </select>
                        </div>
                    </div>

                    <div class="setting-row">
                        <div class="setting-label">–ß–∞—Å–æ–≤–æ–π –ø–æ—è—Å:</div>
                        <div class="setting-control">
                            <select class="modern-select">
                                <option value="-12">UTC-12</option>
                                <option value="-11">UTC-11</option>
                                <option value="-10">UTC-10</option>
                                <option value="-9">UTC-9</option>
                                <option value="-8">UTC-8</option>
                                <option value="-7">UTC-7</option>
                                <option value="-6">UTC-6</option>
                                <option value="-5">UTC-5</option>
                                <option value="-4">UTC-4</option>
                                <option value="-3">UTC-3</option>
                                <option value="-2">UTC-2</option>
                                <option value="-1">UTC-1</option>
                                <option value="0">UTC+0</option>
                                <option value="1">UTC+1</option>
                                <option value="2">UTC+2</option>
                                <option value="3" selected>UTC+3</option>
                                <option value="4">UTC+4</option>
                                <option value="5">UTC+5</option>
                                <option value="6">UTC+6</option>
                                <option value="7">UTC+7</option>
                                <option value="8">UTC+8</option>
                                <option value="9">UTC+9</option>
                                <option value="10">UTC+10</option>
                                <option value="11">UTC+11</option>
                                <option value="12">UTC+12</option>
                            </select>
                        </div>
                    </div>

                    <div class="setting-row">
                        <div class="setting-label">–¢–µ–∫—É—â–µ–µ –≤—Ä–µ–º—è:</div>
                        <div class="current-time-display">12:35</div>
                    </div>

                    <div class="setting-row">
                        <div class="setting-label">–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è:</div>
                        <button class="sync-button" onclick="syncTime()">Sync</button>
                    </div>
                </div>
            </div>

            <div class="section">
                <div class="section-title">–ö–æ–Ω—Ç—Ä–æ–ª—å —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä—ã</div>
                <div class="temp-control-container">
                    <div class="toggle-row">
                        <div class="setting-label">–†–µ–∂–∏–º –∫–æ–Ω—Ç—Ä–æ–ª—è:</div>
                        <label class="modern-toggle">
                            <input type="checkbox" checked>
                            <span class="toggle-slider"></span>
                        </label>
                    </div>
                    <div class="form-group">
                        <div class="range-group">
                            <div class="range-header">
                                <label class="form-label" style="margin-bottom: 0;">–ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞</label>
                                <span class="range-value" id="minTempValue">27¬∞C</span>
                            </div>
                            <input type="range" class="range-input" min="15" max="40" value="27" id="minTemp">
                        </div>
                    </div>
                    <div class="form-group">
                        <div class="range-group">
                            <div class="range-header">
                                <label class="form-label" style="margin-bottom: 0;">–ú–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞</label>
                                <span class="range-value" id="maxTempValue">28¬∞C</span>
                            </div>
                            <input type="range" class="range-input" min="15" max="40" value="28" id="maxTemp">
                        </div>
                    </div>
                </div>
            </div>

            <button class="save-btn" onclick="saveSettings()">
                <i class="fas fa-save"></i> –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
            </button>

            <div class="buttons-row">
                <button class="btn-secondary" onclick="goToMainScreen()">
                    <i class="fas fa-arrow-left"></i> –ù–∞–∑–∞–¥
                </button>
                <button class="btn-danger" onclick="unregisterDevice()">
                    <i class="fas fa-unlink"></i> –û—Ç–≤—è–∑–∞—Ç—å
                </button>
            </div>
        </div>
    </div>

    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script>
        const tg = window.Telegram.WebApp;
        tg.expand();
        document.documentElement.style.setProperty('--tg-theme-bg-color', window.Telegram.WebApp.backgroundColor);

        // –≠–ª–µ–º–µ–Ω—Ç—ã –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞ –¥–ª—è –¥–∞–Ω–Ω—ã—Ö
        const dataCards = document.querySelectorAll('.data-card');
        const tempElement = dataCards[0]?.querySelector('.data-value');
        const humElement = dataCards[1]?.querySelector('.data-value');
        const vpdElement = dataCards[2]?.querySelector('.data-value');
        const brightnessElement = dataCards[3]?.querySelector('.data-value');
        const currentTimeDisplay = document.querySelector('.current-time-display');

        const deviceNameInput = document.getElementById('deviceNameInput');
        const statusElement = document.querySelector('.status');

        // –≠–ª–µ–º–µ–Ω—Ç—ã –∫–æ–Ω—Ç—Ä–æ–ª–æ–≤ –¥–ª—è LED
        const minBrightnessInput = document.getElementById('minBrightness');
        const maxBrightnessInput = document.getElementById('maxBrightness');
        const minBrightnessValue = document.getElementById('minBrightnessValue');
        const maxBrightnessValue = document.getElementById('maxBrightnessValue');

        // –≠–ª–µ–º–µ–Ω—Ç—ã –¥–ª—è —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è
        const timeInputs = document.querySelectorAll('.time-input');
        const sunsetSelect = document.querySelector('.modern-select');
        const timezoneSelect = document.querySelectorAll('.modern-select')[1];

        // –≠–ª–µ–º–µ–Ω—Ç—ã –¥–ª—è —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä—ã
        const minTempInput = document.getElementById('minTemp');
        const maxTempInput = document.getElementById('maxTemp');
        const minTempValue = document.getElementById('minTempValue');
        const maxTempValue = document.getElementById('maxTempValue');

        // –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è
        let deviceId = null;
        let telegramId = null;
        let isDeviceOnline = false;
        let isSaving = false;

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–∫–∞–∑–∞ —Å–æ–æ–±—â–µ–Ω–∏–π
        function showMessage(text, type = 'success') {
            const container = document.getElementById('notificationContainer');
            const notification = document.createElement('div');

            notification.className = `notification ${type}`;
            notification.innerHTML = `
                <span>${text}</span>
                <i class="fas ${type === 'success' ? 'fa-check-circle' : 'fa-exclamation-circle'}"></i>
            `;

            container.appendChild(notification);

            // Remove notification after delay
            setTimeout(() => {
                notification.style.animation = 'slideOut 0.3s ease forwards';
                setTimeout(() => {
                    container.removeChild(notification);
                }, 300);
            }, 4000);
        }

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ –∏–∑ URL –∏–ª–∏ sessionStorage
        function getUrlParams() {
            console.log("üîó –ü–æ–ª–Ω—ã–π URL:", window.location.href);
            console.log("üîó window.location.search:", window.location.search);

            const urlParams = new URLSearchParams(window.location.search);
            console.log("üìã URLSearchParams –∏—Ç–µ—Ä–∞—Ç–æ—Ä:");
            for (let [key, value] of urlParams) {
                console.log(`  ${key} = ${value}`);
            }

            let result = {
                device_id: urlParams.get('device_id'),
                device_name: urlParams.get('device_name')
            };

            // –ï—Å–ª–∏ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –Ω–µ –≤ URL, –ø—ã—Ç–∞–µ–º—Å—è –ø–æ–ª—É—á–∏—Ç—å –∏–∑ sessionStorage
            if (!result.device_id) {
                console.log("üì¶ URL –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç, –ø—Ä–æ–≤–µ—Ä—è–µ–º sessionStorage...");
                try {
                    const savedState = JSON.parse(sessionStorage.getItem('iotHubState'));
                    if (savedState && savedState.currentDevice) {
                        result.device_id = savedState.currentDevice.id;
                        result.device_name = savedState.currentDevice.name;
                        console.log("‚úÖ –ü–∞—Ä–∞–º–µ—Ç—Ä—ã –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã –∏–∑ sessionStorage:", result);
                    }
                } catch (error) {
                    console.error("‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —á—Ç–µ–Ω–∏–∏ sessionStorage:", error);
                }
            }

            console.log("üìã –ò—Ç–æ–≥–æ–≤—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã:", result);
            return result;
        }

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞
        function updateDeviceStatus(online) {
            isDeviceOnline = online;
            console.log("üîÑ –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞:", online ? "–û–Ω–ª–∞–π–Ω" : "–û—Ñ—Ñ–ª–∞–π–Ω");

            if (online) {
                statusElement.innerHTML = '<div class="status-dot-online"></div>–û–Ω–ª–∞–π–Ω';
            } else {
                statusElement.innerHTML = '<div class="status-dot-offline"></div>–û—Ñ—Ñ–ª–∞–π–Ω';
            }

            // –ë–ª–æ–∫–∏—Ä—É–µ–º/—Ä–∞–∑–±–ª–æ–∫–∏—Ä—É–µ–º —ç–ª–µ–º–µ–Ω—Ç—ã —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è
            const controls = document.querySelectorAll('.range-input, .modern-select, .time-input, .save-btn, .sync-button');
            controls.forEach(control => {
                control.disabled = !online;
                control.style.opacity = online ? '1' : '0.5';
            });
        }

        // –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞
        async function loadDeviceData() {
            if (!deviceId || !telegramId || isSaving) {
                console.log("‚è≠Ô∏è –ü—Ä–æ–ø—É—Å–∫ –∑–∞–≥—Ä—É–∑–∫–∏:", { deviceId, telegramId, isSaving });
                return;
            }

            const url = `https://iot-backend-bor5.onrender.com/api/devices/${deviceId}/data?telegram_id=${telegramId}`;
            console.log("üì° –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö —Å:", url);

            try {
                const response = await fetch(url);
                console.log("‚úÖ HTTP —Å—Ç–∞—Ç—É—Å:", response.status);

                const data = await response.json();
                console.log("üì¶ –ü–æ–ª—É—á–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ:", data);

                if (response.ok && data) {
                    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ –¥–∞–Ω–Ω—ã–µ –æ—Ç —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞ (30 —Å–µ–∫—É–Ω–¥)
                    const hasRecentData = data.timestamp &&
                        (new Date() - new Date(data.timestamp)) < 30000;

                    console.log("üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–≤–µ–∂–µ—Å—Ç–∏ –¥–∞–Ω–Ω—ã—Ö:", {
                        timestamp: data.timestamp,
                        hasRecentData: hasRecentData
                    });

                    updateDeviceStatus(hasRecentData);

                    if (!hasRecentData) {
                        console.log("‚ùå –ù–µ—Ç —Å–≤–µ–∂–∏—Ö –¥–∞–Ω–Ω—ã—Ö");
                        if (tempElement) tempElement.textContent = '--¬∞C';
                        if (humElement) humElement.textContent = '--%';
                        if (vpdElement) vpdElement.textContent = '--kPa';
                        if (brightnessElement) brightnessElement.textContent = '--%';
                        if (currentTimeDisplay) currentTimeDisplay.textContent = '--:--';
                        return;
                    }

                    // –û–±–Ω–æ–≤–ª—è–µ–º —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä—É
                    if (data.temperature !== undefined && data.temperature !== null) {
                        const tempValue = Number(data.temperature).toFixed(1);
                        console.log("üå°Ô∏è –¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞:", tempValue);
                        if (tempElement) tempElement.textContent = tempValue + '¬∞C';
                    }

                    // –û–±–Ω–æ–≤–ª—è–µ–º –≤–ª–∞–∂–Ω–æ—Å—Ç—å
                    if (data.humidity !== undefined && data.humidity !== null) {
                        const humValue = Number(data.humidity).toFixed(1);
                        console.log("üíß –í–ª–∞–∂–Ω–æ—Å—Ç—å:", humValue);
                        if (humElement) humElement.textContent = humValue + '%';
                    }

                    // –û–±–Ω–æ–≤–ª—è–µ–º VPD
                    if (data.vpd !== undefined && data.vpd !== null) {
                        const vpdValue = Number(data.vpd).toFixed(2);
                        console.log("üìä VPD:", vpdValue);
                        if (vpdElement) vpdElement.textContent = vpdValue + ' kPa';
                    }

                    // –û–±–Ω–æ–≤–ª—è–µ–º —Ç–µ–∫—É—â—É—é —è—Ä–∫–æ—Å—Ç—å LED
                    if (data.currentLedPower !== undefined && data.currentLedPower !== null) {
                        const brightValue = Math.round(data.currentLedPower);
                        console.log("üí° –¢–µ–∫—É—â–∞—è —è—Ä–∫–æ—Å—Ç—å LED:", brightValue);
                        if (brightnessElement) brightnessElement.textContent = brightValue + '%';
                    }

                    // –û–±–Ω–æ–≤–ª—è–µ–º –≤—Ä–µ–º—è —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞ –∏–∑ timestamp
                    if (data.timestamp) {
                        console.log("‚è∞ –í—Ä–µ–º—è —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞:", data.timestamp);

                        // –ü–∞—Ä—Å–∏–º –¥–∞—Ç—É –∏ —Ñ–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º —Ç–æ–ª—å–∫–æ —á–∞—Å—ã:–º–∏–Ω—É—Ç—ã
                        const date = new Date(data.timestamp);
                        const timeString = date.toLocaleTimeString('ru-RU', {
                            hour: '2-digit',
                            minute: '2-digit'
                        });

                        if (currentTimeDisplay) currentTimeDisplay.textContent = timeString;
                    }

                    // –ó–∞–≥—Ä—É–∂–∞–µ–º –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞ –∏–∑ MQTT
                    if (data.ledLow !== undefined) {
                        console.log("‚öôÔ∏è –ó–∞–≥—Ä—É–∂–∞–µ–º –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ LED");
                        minBrightnessInput.value = data.ledLow;
                        minBrightnessValue.textContent = data.ledLow + '%';
                        updateRangeProgress(minBrightnessInput);
                    }

                    if (data.ledPower !== undefined) {
                        maxBrightnessInput.value = data.ledPower;
                        maxBrightnessValue.textContent = data.ledPower + '%';
                        updateRangeProgress(maxBrightnessInput);
                    }

                    if (data.durationSun !== undefined) {
                        sunsetSelect.value = data.durationSun;
                        console.log("üåÖ –†–∞—Å—Å–≤–µ—Ç/–∑–∞–∫–∞—Ç:", data.durationSun + ' –º–∏–Ω');
                    }

                    if (data.zoneUTC !== undefined) {
                        timezoneSelect.value = data.zoneUTC;
                        console.log("üïê –ß–∞—Å–æ–≤–æ–π –ø–æ—è—Å:", 'UTC' + (data.zoneUTC >= 0 ? '+' : '') + data.zoneUTC);
                    }

                    // –û–±–Ω–æ–≤–ª—è–µ–º —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ –æ—Å–≤–µ—â–µ–Ω–∏—è
                    if (data.ledOnHour !== undefined && data.ledOnMinute !== undefined) {
                        const onHour = String(data.ledOnHour).padStart(2, '0');
                        const onMinute = String(data.ledOnMinute).padStart(2, '0');
                        timeInputs[0].value = onHour + ':' + onMinute;
                        console.log("üîÜ –í–∫–ª—é—á–µ–Ω–∏–µ –≤:", onHour + ':' + onMinute);
                    }

                    if (data.ledOffHour !== undefined && data.ledOffMinute !== undefined) {
                        const offHour = String(data.ledOffHour).padStart(2, '0');
                        const offMinute = String(data.ledOffMinute).padStart(2, '0');
                        timeInputs[1].value = offHour + ':' + offMinute;
                        console.log("üåë –í—ã–∫–ª—é—á–µ–Ω–∏–µ –≤:", offHour + ':' + offMinute);
                    }

                    // –û–±–Ω–æ–≤–ª—è–µ–º —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã
                    if (data.tempLow !== undefined) {
                        minTempInput.value = Math.round(data.tempLow);
                        minTempValue.textContent = Math.round(data.tempLow) + '¬∞C';
                        updateRangeProgress(minTempInput);
                        console.log("‚ùÑÔ∏è –ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞:", data.tempLow);
                    }

                    if (data.tempHigh !== undefined) {
                        maxTempInput.value = Math.round(data.tempHigh);
                        maxTempValue.textContent = Math.round(data.tempHigh) + '¬∞C';
                        updateRangeProgress(maxTempInput);
                        console.log("üî• –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞:", data.tempHigh);
                    }
                } else {
                    console.error("‚ùå –û—à–∏–±–∫–∞ –æ—Ç–≤–µ—Ç–∞ —Å–µ—Ä–≤–µ—Ä–∞");
                    updateDeviceStatus(false);
                }
            } catch (error) {
                console.error('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö:', error);
                updateDeviceStatus(false);
            }
        }

        // –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ —Ü–≤–µ—Ç–æ–≤–æ–π —Å—Ö–µ–º—ã Telegram
        function applyTelegramTheme() {
            document.documentElement.style.setProperty('--tg-theme-bg-color', tg.backgroundColor);
            document.documentElement.style.setProperty('--tg-theme-text-color', tg.textColor);
            document.documentElement.style.setProperty('--tg-theme-hint-color', tg.hintColor);
            document.documentElement.style.setProperty('--tg-theme-button-color', tg.buttonColor);
            document.documentElement.style.setProperty('--tg-theme-button-text-color', tg.buttonTextColor);
            document.documentElement.style.setProperty('--tg-theme-secondary-bg-color', tg.secondaryBgColor);

            const isDarkTheme = tg.colorScheme === 'dark';
            if (isDarkTheme) {
                const darkContainerStyle = document.createElement('style');
                darkContainerStyle.textContent = `
                    .data-card,
                    .lighting-control-container,
                    .schedule-container,
                    .temp-control-container,
                    .time-input,
                    .modern-select {
                        background: #28283c !important;
                    }
                    .setting-row {
                        border-bottom: 1px solid #404050 !important;
                    }
                    .setting-row:last-child {
                        border-bottom: none !important;
                        padding-bottom: 0 !important;
                    }
                    .toggle-row {
                        border-bottom: 1px solid #404050 !important;
                    }
                `;
                document.head.appendChild(darkContainerStyle);
            }
        }

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –ø—Ä–æ–≥—Ä–µ—Å—Å–∞ –ø–æ–ª–∑—É–Ω–∫–∞
        function updateRangeProgress(input) {
            const value = ((input.value - input.min) / (input.max - input.min)) * 100;
            input.style.setProperty('--range-progress', value + '%');
        }

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∑–Ω–∞—á–µ–Ω–∏–π —Å–ª–∞–π–¥–µ—Ä–æ–≤ —Å –≤–∞–ª–∏–¥–∞—Ü–∏–µ–π
        document.getElementById('minBrightness').addEventListener('input', function () {
            const maxBrightness = document.getElementById('maxBrightness');
            const minValue = parseInt(this.value);
            const maxValue = parseInt(maxBrightness.value);

            if (minValue >= maxValue) {
                maxBrightness.value = minValue + 1;
                document.getElementById('maxBrightnessValue').textContent = maxBrightness.value + '%';
                updateRangeProgress(maxBrightness);
            }

            document.getElementById('minBrightnessValue').textContent = this.value + '%';
            updateRangeProgress(this);
        });

        document.getElementById('maxBrightness').addEventListener('input', function () {
            const minBrightness = document.getElementById('minBrightness');
            const minValue = parseInt(minBrightness.value);
            const maxValue = parseInt(this.value);

            if (maxValue <= minValue) {
                minBrightness.value = maxValue - 1;
                document.getElementById('minBrightnessValue').textContent = minBrightness.value + '%';
                updateRangeProgress(minBrightness);
            }

            document.getElementById('maxBrightnessValue').textContent = this.value + '%';
            updateRangeProgress(this);
        });

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∑–Ω–∞—á–µ–Ω–∏–π —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä–Ω—ã—Ö —Å–ª–∞–π–¥–µ—Ä–æ–≤ —Å –≤–∞–ª–∏–¥–∞—Ü–∏–µ–π
        document.getElementById('minTemp').addEventListener('input', function () {
            const maxTemp = document.getElementById('maxTemp');
            const minValue = parseInt(this.value);
            const maxValue = parseInt(maxTemp.value);

            if (minValue >= maxValue) {
                maxTemp.value = minValue + 1;
                document.getElementById('maxTempValue').textContent = maxTemp.value + '¬∞C';
                updateRangeProgress(maxTemp);
            }

            document.getElementById('minTempValue').textContent = this.value + '¬∞C';
            updateRangeProgress(this);
        });

        document.getElementById('maxTemp').addEventListener('input', function () {
            const minTemp = document.getElementById('minTemp');
            const minValue = parseInt(minTemp.value);
            const maxValue = parseInt(this.value);

            if (maxValue <= minValue) {
                minTemp.value = maxValue - 1;
                document.getElementById('minTempValue').textContent = minTemp.value + '¬∞C';
                updateRangeProgress(minTemp);
            }

            document.getElementById('maxTempValue').textContent = this.value + '¬∞C';
            updateRangeProgress(this);
        });

        // –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è –∫–Ω–æ–ø–æ–∫
        async function saveSettings() {
            if (!isDeviceOnline) {
                showMessage('–£—Å—Ç—Ä–æ–π—Å—Ç–≤–æ –æ—Ñ—Ñ–ª–∞–π–Ω. –ù–µ–≤–æ–∑–º–æ–∂–Ω–æ —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏.', 'error');
                return;
            }

            if (!deviceId || !telegramId) {
                showMessage('–û—à–∏–±–∫–∞: Device ID –Ω–µ –Ω–∞–π–¥–µ–Ω', 'error');
                return;
            }

            isSaving = true;
            const btn = document.querySelector('.save-btn');
            const originalText = btn.textContent;
            btn.textContent = '–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ...';
            btn.disabled = true;

            try {
                // –°–æ–±–∏—Ä–∞–µ–º –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ —Å —Ñ–æ—Ä–º—ã
                const settings = {
                    ledLow: parseInt(minBrightnessInput.value),
                    ledPower: parseInt(maxBrightnessInput.value),
                    durationSun: parseInt(sunsetSelect.value),
                    zoneUTC: parseInt(timezoneSelect.value),
                    ledOnHour: parseInt(timeInputs[0].value.split(':')[0]),
                    ledOnMinute: parseInt(timeInputs[0].value.split(':')[1]),
                    ledOffHour: parseInt(timeInputs[1].value.split(':')[0]),
                    ledOffMinute: parseInt(timeInputs[1].value.split(':')[1]),
                    tempLow: parseFloat(minTempInput.value),
                    tempHigh: parseFloat(maxTempInput.value)
                };

                console.log("üì§ –û—Ç–ø—Ä–∞–≤–∫–∞ –Ω–∞—Å—Ç—Ä–æ–µ–∫:", settings);

                // –°–æ—Ö—Ä–∞–Ω—è–µ–º –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
                const settingsResponse = await fetch(
                    `https://iot-backend-bor5.onrender.com/api/devices/${deviceId}/settings`,
                    {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            telegram_id: telegramId,
                            settings: settings
                        })
                    }
                );

                // –°–æ—Ö—Ä–∞–Ω—è–µ–º –∏–º—è —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞
                const newName = deviceNameInput.value.trim();
                const nameResponse = await fetch(
                    `https://iot-backend-bor5.onrender.com/api/devices/${deviceId}/name`,
                    {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            telegram_id: telegramId,
                            name: newName
                        })
                    }
                );

                if (settingsResponse.ok && nameResponse.ok) {
                    console.log("‚úÖ –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –∏ –∏–º—è —É—Å–ø–µ—à–Ω–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã");
                    showMessage('–ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã');
                    btn.textContent = '–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ ‚úì';
                    btn.style.background = 'linear-gradient(135deg, #48bb78 0%, #38a169 100%)';

                    setTimeout(() => {
                        btn.textContent = originalText;
                        btn.style.background = '';
                        btn.disabled = false;
                        isSaving = false;
                    }, 2000);
                } else {
                    const settingsError = await settingsResponse.json().catch(() => ({}));
                    const nameError = await nameResponse.json().catch(() => ({}));
                    console.error("‚ùå –û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è:", { settingsError, nameError });

                    showMessage(
                        settingsError.error || nameError.error || '–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è',
                        'error'
                    );

                    btn.textContent = originalText;
                    btn.disabled = false;
                    isSaving = false;
                }
            } catch (error) {
                console.error('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏:', error);
                showMessage('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ –Ω–∞—Å—Ç—Ä–æ–µ–∫', 'error');
                btn.textContent = originalText;
                btn.disabled = false;
                isSaving = false;
            }
        }

        function syncTime() {
            const btn = document.querySelector('.sync-button');
            const originalText = btn.textContent;
            btn.textContent = '‚ü≥';
            btn.style.animation = 'spin 1s linear infinite';
            btn.disabled = true;

            // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∫–æ–º–∞–Ω–¥—É —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ –≤—Ä–µ–º–µ–Ω–∏
            const settings = {
                zoneUTC: parseInt(timezoneSelect.value)
            };

            fetch(
                `https://iot-backend-bor5.onrender.com/api/devices/${deviceId}/settings`,
                {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        telegram_id: telegramId,
                        settings: settings
                    })
                }
            ).then(() => {
                btn.textContent = '‚úì';
                btn.style.animation = 'none';
                setTimeout(() => {
                    btn.textContent = originalText;
                    btn.disabled = false;
                }, 1000);
            }).catch(error => {
                console.error('–û—à–∏–±–∫–∞ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ –≤—Ä–µ–º–µ–Ω–∏:', error);
                btn.textContent = originalText;
                btn.style.animation = 'none';
                btn.disabled = false;
            });
        }

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –Ω–∞–∑–≤–∞–Ω–∏—è —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ
        async function updateDeviceName(newName) {
            if (!deviceId || !telegramId) return;

            try {
                const response = await fetch(
                    `https://iot-backend-bor5.onrender.com/api/devices/${deviceId}/name`,
                    {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            telegram_id: telegramId,
                            name: newName
                        })
                    }
                );

                if (response.ok) {
                    console.log("‚úÖ –ù–∞–∑–≤–∞–Ω–∏–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–æ");
                } else {
                    console.error("‚ùå –û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –Ω–∞–∑–≤–∞–Ω–∏—è");
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ –Ω–∞–∑–≤–∞–Ω–∏—è:', error);
            }
        }

        // –°–ª—É—à–∞—Ç–µ–ª—å –¥–ª—è –∏–∑–º–µ–Ω–µ–Ω–∏—è –Ω–∞–∑–≤–∞–Ω–∏—è —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞
        deviceNameInput?.addEventListener('change', debounce(function () {
            const newName = this.value.trim();
            if (newName) {
                updateDeviceName(newName);
            }
        }, 1000));

        // –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è debounce
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func.apply(this, args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        // –û—Ç–≤—è–∑–∫–∞ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞
        async function unregisterDevice() {
            const confirmed = confirm(`–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –æ—Ç–≤—è–∑–∞—Ç—å —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ ${deviceId}?`);
            if (!confirmed) return;

            try {
                const response = await fetch("https://iot-backend-bor5.onrender.com/api/auth/unregister-device", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({
                        telegram_id: telegramId,
                        device_id: deviceId
                    })
                });

                if (response.ok) {
                    tg.showAlert('–£—Å—Ç—Ä–æ–π—Å—Ç–≤–æ —É—Å–ø–µ—à–Ω–æ –æ—Ç–≤—è–∑–∞–Ω–æ');
                    window.location.href = '../index.html';
                } else {
                    const result = await response.json();
                    tg.showAlert(result.error || '–û—à–∏–±–∫–∞ –æ—Ç–≤—è–∑–∫–∏');
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –æ—Ç–≤—è–∑–∫–∏:', error);
                tg.showAlert('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏');
            }
        }

        // –í–æ–∑–≤—Ä–∞—Ç –Ω–∞ –≥–ª–∞–≤–Ω—ã–π —ç–∫—Ä–∞–Ω
        function goToMainScreen() {
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–æ–ª—å–∫–æ —Ç–µ–∫—É—â–∏–µ –¥–∞–Ω–Ω—ã–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞
            // const stateToSave = {
            //     deviceData: [[deviceId, {
            //         temperature: tempElement.textContent,
            //         humidity: humElement.textContent,
            //         vpd: vpdElement.textContent,
            //         timestamp: new Date().toISOString()
            //     }]],
            //     deviceStatuses: [[deviceId, isDeviceOnline ? 'online' : 'offline']],
            //     lastUpdate: new Date().getTime()
            // };

            // try {
            //     sessionStorage.setItem('iotHubState', JSON.stringify(stateToSave));
            // } catch (error) {
            //     console.error('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —Å–æ—Å—Ç–æ—è–Ω–∏—è:', error);
            // }

            window.location.href = '../index.html';
        }

        // function unbindDevice() {
        //     if (confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –æ—Ç–≤—è–∑–∞—Ç—å —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ?')) {
        //         const btn = document.querySelector('.btn-danger');
        //         btn.textContent = '–û—Ç–≤—è–∑–∞–Ω–æ';
        //         btn.style.background = '#fed7d7';
        //     }
        // }

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
        async function initApp() {
            console.log("üöÄ –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è");

            // –ü—Ä–∏–º–µ–Ω—è–µ–º —Ç–µ–º—É Telegram
            applyTelegramTheme();

            // –ü–æ–ª—É—á–∞–µ–º –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –∏–∑ URL
            const params = getUrlParams();
            deviceId = params.device_id;
            const deviceNameValue = params.device_name || deviceId || 'Smart Dimmer';

            console.log("üì± Device ID:", deviceId);
            console.log("üìù Device Name:", deviceNameValue);

            if (deviceNameInput) {
                deviceNameInput.value = deviceNameValue;
            }

            // –ü–æ–ª—É—á–∞–µ–º telegram_id –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            const telegramUser = tg.initDataUnsafe?.user;
            if (!telegramUser) {
                console.error("‚ùå –û—à–∏–±–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏");
                return;
            }
            telegramId = telegramUser.id;
            console.log("üë§ Telegram ID:", telegramId);

            // –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –Ω–∞—á–∞–ª—å–Ω—ã—Ö –∑–Ω–∞—á–µ–Ω–∏–π (–∑–Ω–∞—á–µ–Ω–∏—è –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –∏–∑ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞)
            minBrightnessInput.value = 20;
            maxBrightnessInput.value = 40;
            minBrightnessValue.textContent = '20%';
            maxBrightnessValue.textContent = '40%';
            minTempInput.value = 27;
            maxTempInput.value = 28;
            minTempValue.textContent = '27¬∞C';
            maxTempValue.textContent = '28¬∞C';
            sunsetSelect.value = 60;
            timezoneSelect.value = 3;
            timeInputs[0].value = '08:00';
            timeInputs[1].value = '20:00';

            // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –ø–æ–ª–∑—É–Ω–∫–∏ –¥–ª—è –≤–∏–∑—É–∞–ª—å–Ω–æ–≥–æ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –ø—Ä–æ–≥—Ä–µ—Å—Å–∞
            const rangeInputs = document.querySelectorAll('.range-input');
            rangeInputs.forEach(input => {
                updateRangeProgress(input);
                input.addEventListener('input', function () {
                    updateRangeProgress(this);
                });
            });

            // –ó–∞–≥—Ä—É–∂–∞–µ–º –Ω–∞—á–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
            console.log("üì• –ó–∞–≥—Ä—É–∑–∫–∞ –Ω–∞—á–∞–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö");
            await loadDeviceData();

            // –ó–∞–ø—É—Å–∫–∞–µ–º –ø–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ (–∫–∞–∂–¥—ã–µ 5 —Å–µ–∫—É–Ω–¥)
            console.log("‚è∞ –ó–∞–ø—É—Å–∫ –ø–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–æ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è");
            setInterval(loadDeviceData, 5000);
        }

        // CSS –∞–Ω–∏–º–∞—Ü–∏—è –¥–ª—è –∫–Ω–æ–ø–∫–∏ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏
        const style = document.createElement('style');
        style.textContent = `
            @keyframes spin {
                from { transform: rotate(0deg); }
                to { transform: rotate(360deg); }
            }
        `;
        document.head.appendChild(style);

        // –ó–∞–ø—É—Å–∫–∞–µ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ DOM
        document.addEventListener('DOMContentLoaded', initApp);
    </script>
</body>

</html>