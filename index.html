<!DOCTYPE html>
<html lang="ru">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Climate Control</title>
    <style>
        body {
            font-family: sans-serif;
            padding: 20px;
        }

        .section {
            margin-bottom: 20px;
        }

        input[type=range] {
            width: 100%;
        }

        .value {
            font-weight: bold;
        }

        button {
            padding: 10px;
            font-size: 16px;
            width: 100%;
        }
    </style>
</head>

<body>
    <h2>üå°Ô∏è Climate Control</h2>

    <div class="section">
        <p>–¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞: <span id="temp">--</span> ¬∞C</p>
        <p>–í–ª–∞–∂–Ω–æ—Å—Ç—å: <span id="hum">--</span> %</p>
        <p>–¢–µ–∫—É—â–∏–π –ø–æ—Ä–æ–≥: <span id="threshold">--</span> ¬∞C</p>
    </div>

    <div class="section">
        <label for="slider">–ù–æ–≤—ã–π –ø–æ—Ä–æ–≥: <span id="sliderVal">25</span> ¬∞C</label>
        <input type="range" id="slider" min="0" max="40" value="25">
    </div>

    <div class="section">
        <button onclick="saveThreshold()">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
    </div>

    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script>
        const tg = window.Telegram.WebApp;
        tg.expand();

        const slider = document.getElementById("slider");
        const sliderVal = document.getElementById("sliderVal");

        const temp = document.getElementById("temp");
        const hum = document.getElementById("hum");
        const threshold = document.getElementById("threshold");

        async function loadData() {
            try {
                const res = await fetch("https://iot-backend-bor5.onrender.com/get-latest");
                const data = await res.json();
                if (data.temperature !== null) {
                    temp.textContent = data.temperature;
                    hum.textContent = data.humidity;
                    threshold.textContent = data.threshold;

                    // –û–±–Ω–æ–≤–ª—è–µ–º –ø–æ–ª–∑—É–Ω–æ–∫, —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ù–ï –¥–≤–∏–≥–∞–µ—Ç –µ–≥–æ —Å–∞–º
                    if (!slider.matches(':active')) {
                        slider.value = data.threshold;
                        sliderVal.textContent = data.threshold;
                    }
                }
            } catch (e) {
                console.warn("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö:", e);
            }
        }

        slider.addEventListener("input", () => {
            sliderVal.textContent = slider.value;
        });

        async function saveThreshold() {
            const newThreshold = parseFloat(slider.value);
            try {
                const res = await fetch("https://iot-backend-bor5.onrender.com/set-threshold", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ threshold: newThreshold })
                });
                if (res.ok) {
                    tg.showAlert("‚úÖ –ü–æ—Ä–æ–≥ —Å–æ—Ö—Ä–∞–Ω—ë–Ω!");
                    threshold.textContent = newThreshold;
                } else {
                    tg.showAlert("‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏");
                }
            } catch (e) {
                tg.showAlert("‚ùå –°–µ—Ç—å –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞");
                console.error(e);
            }
        }

        // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ
        loadData();

        // üîÅ –ê–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–∞–∂–¥—ã–µ 5 —Å–µ–∫—É–Ω–¥
        setInterval(loadData, 5000);
    </script>

</body>

</html>